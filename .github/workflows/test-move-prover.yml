name: Test_Move_Prover

on:
  pull_request:
    types: [opened, reopened, synchronize]
  # repository_dispatch:
  #   types: [new_PR]

jobs:
  install_and_test_Move_Prover:

    runs-on: ubuntu-18.04
    env:
      JOB_ENV: JOB_ENV_1

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
    - name: Dump job context
      env:
        JOB_CONTEXT: ${{ toJson(job) }}
      run: echo "$JOB_CONTEXT"
    - name: Dump steps context
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: echo "$STEPS_CONTEXT"
    - name: Dump runner context
      env:
        RUNNER_CONTEXT: ${{ toJson(runner) }}
      run: echo "$RUNNER_CONTEXT"
    - name: Dump strategy context
      env:
        STRATEGY_CONTEXT: ${{ toJson(strategy) }}
      run: |
        echo "$STRATEGY_CONTEXT"
        echo "::set-env name=BOOGIE_EXE::/home/runner/.dotnet/tools/boogie"

    - name: Dump matrix context
      env:
        MATRIX_CONTEXT: ${{ toJson(matrix) }}
      run: |
        echo "$MATRIX_CONTEXT"
        echo "$STRATEGY_CONTEXT"
        echo "$STEPS_ENV"
        echo "$JOB_ENV"
        echo "$BOOGIE_EXE"

    - name: Dump a few things
      uses: actions/github-script@0.6.0
      with:
        script: |          
          console.log(`https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`);
          console.log(process.env.BOOGIE_EXE + process.env.JOB_ENV);
          console.log(process.env.MATRIX_CONTEXT);

    - name: Checkout libra
      uses: actions/checkout@v2
      with:
        path: "libra"
        # repository: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }} # repo of the forked libra/libra
        # ref: ${{ github.event.client_payload.pull_ref }} # commit that triggered the PR
    - name: Detect the changes in move-prover
      working-directory: ./libra
      run: |
        git fetch origin
        git diff --name-only origin/master
        if (git diff --name-only origin/master | grep "test")
        then
          echo "::set-env name=RUN_TEST::yes"
          exit 0
        else
          echo "::set-env name=RUN_TEST::no"
        fi
#        git diff --name-only origin/master | grep "language/move-prover"

    - name: Fail Fast
      run: |
        (exit 1)
        echo $?
    - name: Backup
      if: failure()
      run: |
        echo backup!

    - name: YES_CASE
      if: env.RUN_TESTT == 'yes'
      run: |
        echo YES!!
        echo $RUN_TEST

 
    - name: NO_CASE
      if: env.RUN_TESTT == 'no'
      run: |
        echo NO!!!
        echo $RUN_TEST
      
    - name: Install Z3
      if: env.RUN_TEST == 'yes'
      uses: pavpanchekha/setup-z3@v1.2
      with:
        version: "4.8.7"
    - name: Install .NET Core SDK and Boogie
      run: |
        wget -q https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install apt-transport-https
        sudo apt-get update
        sudo apt-get install dotnet-sdk-3.1
        dotnet tool install --global Boogie --version 2.5.7
#        dotnet tool install --global Boogie --version 2.4.17

    - name: Export the environment variables
      if: env.RUN_TEST == 'yes'
      run: |
        echo "::set-env name=BOOGIE_EXE::/home/runner/.dotnet/tools/boogie"
        echo "::set-env name=Z3_EXE::`which z3`"
    - name: Test move-prover
      if: env.RUN_TEST == 'yes'
      working-directory: ./libra/language/move-prover/bytecode-to-boogie
      timeout-minutes: 30 # normally, expected to be done within 10 mins.
      run: |
        set -o pipefail
        cargo test 2>&1 | tee cargo_test.log
    - name: Comment the error message if the test failed
      if: env.RUN_TEST == 'yes'
      uses: actions/github-script@0.4.0
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
      #  github-token: ${{secrets.MIRAI_BOT}}
        script: |
          const fs = require('fs');
          fs.readFile('libra/language/move-prover/bytecode-to-boogie/cargo_test.log', 'utf-8', (err, data) => {
            if (err) {
              console.log("err:", err);
              console.log("`cargo test` has not launched. Perhaps, it was skipped because no changes under `language/move-prover` were found.");
              return;
            }
            if (data) {
              lines = data.split('\n');
              data = lines.slice(lines.findIndex(line => line.includes('Running'))).join('\n');
              data = "[move-prover] `cargo test` failed with the following error message: \n```" + data + "```";    
              console.log(data);
            }
          })
